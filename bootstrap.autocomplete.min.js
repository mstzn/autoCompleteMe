!function(e){var t=function(t,n){var a=t,o=!1,r=function(e){for(var t=-1,i=!1,o=e;o>0;o--){for(var r=a.val().substr(o-1,1),s=0;s<n.delimiters.length;s++){if(" "==r){h("space found"),i=!0;break}if(r==n.delimiters[s]){h("char found"),t=o;break}}if(t>-1||1==i)break}return h("delimiter index: "+t),t},s=function(){a.closest("div").find(".autoComplete").slideUp(100,function(){e(this).remove()})},l=function(){return a.caret()},d=function(){return a.getCaretPosition()},c=function(){var e=l(),t=a.val(),n=a.val().length,o=[" ",".",",",";",":","-"];if(e==n)return e;for(i=e;i<n;i++)if(o.indexOf(t.substr(i,1)))return i;return-1},u=function(e,t){a.caret(e,t)},m=function(t,i,o){if(o.length>0){var r="";if(o.length>0)for(item in o)r+=n.itemTemplate.replace("{isActive}",0==item?"active":"").replace("{name}",o[item].name).replace("{image}",o[item].image).replace("{username_delimiter}",i+o[item].username).replace("{username}",o[item].username);var l=e('<ul class="autoComplete dropdown-menu" style="left:'+(d().left-10)+"px; top:"+(d().top+40)+'px"></ul>');""!=n.dropDownClass&&l.addClass(n.dropDownClass),l.append(r),a.closest("div").find(".autoComplete").slideUp(100,function(){e(this).remove()}),a.closest("div").append(l),a.closest("div").find(".autoComplete").slideDown(100),l.find(".dropdown-item").on("click",function(){f()})}else s()},f=function(){var t=l(),i=a.val(),n=c();if(-1!=n){delimiterIndex=r(t);var o=e(".autoComplete").find(".dropdown-item.active").data("value")+" ";h("item choosen: "+o),h("choosen delimiterIndex:"+delimiterIndex),h("choosen nextPost: "+n),a.val(i.substr(0,delimiterIndex)+o+i.substr(n-1,i.length-n-1));var d=delimiterIndex+o.length;u(d,d+1),s()}},v=function(){e(".autoComplete").length>0&&e(".autoComplete").is(":visible")&&(e(".autoComplete").find(".dropdown-item.active").next().length>0?e(".autoComplete").find(".dropdown-item.active").removeClass("active").next().addClass("active"):(e(".autoComplete").find(".dropdown-item.active").removeClass("active"),e(".autoComplete").find(".dropdown-item:first-child").addClass("active")))},p=function(){e(".autoComplete").length>0&&e(".autoComplete").is(":visible")&&(e(".autoComplete").find(".dropdown-item.active").prev().length>0?e(".autoComplete").find(".dropdown-item.active").removeClass("active").prev().addClass("active"):(e(".autoComplete").find(".dropdown-item.active").removeClass("active"),e(".autoComplete").find(".dropdown-item:last-child").addClass("active")))},h=function(e){1==n.debug&&console.log(e)};return a.on("keydown",function(e){13!=e.which&&40!=e.which&&38!=e.which||e.preventDefault()}),a.on("keyup",function(t){var i,d=l(),c=a.val();if(h("Cursor:"+d),27==t.which||32==t.which)return void s();if(13==t.which)return void(e(".autoComplete").length>0&&e(".autoComplete").is(":visible")&&f());if(40==t.which)return void v();if(38==t.which)return void p();if(d>0&&(i=r(d),h(i),i>-1))if(d-i>n.minCharacter){var u=c.substr(i,d-i),C=c.substr(i-1,1);if(""!=u)if(h(C+"+"+u),""!=n.asyncAddress){if(o)return;o=!0,e.post(n.asyncAddress,{delimiter:C,query:u},function(e){m(0,C,e),o=!1},"json").fail(function(){o=!1})}else{var w=[];for(idx in n.staticData)for(var g=0;g<n.queryBy.length;g++){h(n.queryBy[g]+"-"+u);var x=new RegExp(u,"g"+(n.sensitive?"":"i"));-1!=n.staticData[idx][n.queryBy[g]].search(x)&&(w.push(n.staticData[idx]),h(n.staticData[idx]))}m(0,C,w)}else s()}else s()}),a};e.fn.autoCompleteMe=function(i){var n={delimiters:["@"],debug:!1,sensitive:!0,queryBy:["name","username"],minCharacter:2,asyncAddress:!1,itemTemplate:'<li data-value="{username}" class="dropdown-item {isActive}">\n                        <a href="javascript:;"><img class="mention_image" src="{image}">\n                            <b class="mention_name">{name}</b>\n                            <span class="mention_username">{username_delimiter}</span>\n                        </a>\n                    </li>',dropDownClass:"",staticData:[]};return n=e.extend({},n,i),this.each(function(){new t(e(this),n)})}}(jQuery);
